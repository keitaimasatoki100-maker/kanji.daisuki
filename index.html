<!doctype html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼¢å­—ç·´ç¿’ã‚µã‚¤ãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            font-family: 'UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“ N-R', 'UD Digi Kyokasho N-R', 'UDãƒ‡ã‚¸ã‚¿ãƒ«æ•™ç§‘æ›¸ä½“ N-R', 'UDãƒ‡ã‚¸ã‚¿ãƒ«æ•™ç§‘æ›¸ä½“', 'æ•™ç§‘æ›¸ä½“', 'Kyokasho', 'BIZ UDPGothic', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Meiryo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            writing-mode: vertical-rl;
            text-orientation: upright;
            padding-top: 10px;
            box-sizing: border-box;
            overflow-x: auto;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-height: 95vh;
            height: 100%;
            text-align: center;
            writing-mode: vertical-rl;
            text-orientation: upright;
            overflow-y: hidden;
            overflow-x: auto;
            margin-top: 0;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #cardsArea {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            align-content: flex-start;
            height: 100%;
            overflow-x: auto;
            padding: 30px 0 10px 0;
        }
        
        .sentence-card {
            background: #f7fafc;
            border-radius: 15px;
            padding: 15px;
            margin: 0 10px;
            border-top: 5px solid #667eea;
            writing-mode: vertical-rl;
            text-orientation: upright;
            display: inline-block;
            vertical-align: top;
            min-height: 400px;
            width: 60px;
            position: relative;
            flex-shrink: 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }
        
        .problem-number {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1rem;
            font-weight: bold;
            color: #667eea;
            background: white;
            padding: 2px 8px;
            border-radius: 12px;
            border: 2px solid #667eea;
            writing-mode: horizontal-tb;
            z-index: 20;
        }
        
        .sentence {
            font-size: 1.5rem;
            line-height: 1.8;
            color: #2d3748;
            margin-top: 15px;
        }
        
        .kanji-blank {
            display: inline-block;
            width: 42px;
            min-height: 42px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            margin: 4px 2px;
            vertical-align: middle;
            background: white;
            position: relative;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .kanji-blank::before {
            content: attr(data-reading);
            position: absolute;
            right: -28px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            color: #2d3748;
            background: #e2e8f0;
            padding: 4px 2px;
            border-radius: 4px;
            white-space: nowrap;
            font-weight: bold;
        }
        
        .kanji-blank.revealed {
            border: 2px solid #48bb78;
            background: #f0fff4;
            color: #2d3748;
            font-weight: bold;
        }
        
        .reveal-btn {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            writing-mode: vertical-rl;
        }
        
        .individual-btn {
            position: absolute;
            left: -14px;
            top: 50%;
            transform: translateY(-50%);
            padding: 8px 3px;
            font-size: 0.65rem;
            border-radius: 12px;
            writing-mode: vertical-rl;
            text-orientation: upright;
            z-index: 10;
            line-height: 1.1;
            white-space: nowrap;
        }
        
        .controls {
            margin-right: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            writing-mode: vertical-rl;
        }
        
        .progress {
            margin-right: 10px;
            font-size: 1.1rem;
            color: #4a5568;
            font-weight: bold;
        }

        #editDialog {
            writing-mode: horizontal-tb;
        }

        .dojo-title {
            color: #2d3748;
            font-size: 1.8rem;
            font-weight: 900;
            margin-right: 40px;
            padding: 10px;
            border-left: 4px double #4a5568;
            background-color: rgba(247, 250, 252, 0.5);
            border-radius: 0 0 10px 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šã‚¨ãƒªã‚¢ -->
        <div style="position: absolute; top: 15px; right: 15px; display: flex; flex-direction: row; align-items: flex-start; gap: 15px; writing-mode: vertical-rl; text-orientation: upright; z-index: 100;">
            <!-- å­¦å¹´ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ -->
            <select id="gradeSelector" onchange="onGradeChange()" style="background: white; border: 2px solid #cbd5e0; border-radius: 12px; padding: 8px 12px; font-size: 0.7rem; font-weight: bold; cursor: pointer; writing-mode: vertical-rl; min-width: 60px;">
                <option value="all">ã™ã¹ã¦ã®å­¦å¹´</option>
            </select>

            <!-- å˜å…ƒã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼ˆå­¦å¹´ã«é€£å‹•ã—ã€ã‚·ãƒ¼ãƒˆé †ã«è¡¨ç¤ºï¼‰ -->
            <select id="unitSelector" onchange="onUnitChange()" style="background: white; border: 2px solid #cbd5e0; border-radius: 12px; padding: 8px 12px; font-size: 0.7rem; font-weight: bold; cursor: pointer; writing-mode: vertical-rl; min-width: 60px; margin-top: 10px;">
                <option value="all">ã™ã¹ã¦ã®å˜å…ƒ</option>
            </select>

            <select id="rangeSelector" onchange="onRangeChange()" style="background: white; border: 2px solid #cbd5e0; border-radius: 12px; padding: 8px 12px; font-size: 0.7rem; font-weight: bold; cursor: pointer; writing-mode: vertical-rl; min-width: 40px; margin-top: 10px;">
                <option value="up-to">ã¾ã§</option>
                <option value="only">ã ã‘</option>
            </select>

            <button onclick="shuffleProblems()" class="bg-gradient-to-br from-purple-500 to-indigo-600 text-white border-none p-3 rounded-2xl text-sm font-bold cursor-pointer mt-10" style="writing-mode: vertical-rl;">
                ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            </button>
        </div>

        <div style="margin-right: 110px;"></div>

        <div class="dojo-title">
            æœ€å¼·ï¼æ¼¢å­—é“å ´
        </div>

        <!-- ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="cardsArea"></div>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="controls">
            <button class="reveal-btn" id="globalToggleBtn" onclick="toggleAllReveals()">ã™ã¹ã¦è¡¨ç¤º</button>
            <button class="reveal-btn" onclick="showEditDialog()" style="background: linear-gradient(135deg, #f56565, #e53e3e);">å•é¡Œç·¨é›†</button>
        </div>
    </div>

    <!-- ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div id="editDialog" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1000] p-4">
        <div class="bg-white p-6 rounded-2xl max-w-5xl w-full max-h-[90vh] overflow-auto flex flex-col">
            <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">å•é¡Œç·¨é›† - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ</h2>
            
            <div id="passwordSection">
                <label class="block mb-2 font-bold">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="passwordInput" class="w-full p-2 border-2 rounded-lg mb-4" onkeypress="if(event.key==='Enter') checkPassword()">
                <div class="flex gap-2">
                    <button onclick="checkPassword()" class="bg-green-500 text-white px-4 py-2 rounded-lg">ç¢ºèª</button>
                    <button onclick="closeEditDialog()" class="bg-gray-200 px-4 py-2 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>

            <div id="editSection" class="hidden flex-1 flex flex-col overflow-hidden">
                <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-200 mb-4">
                    <label class="block font-bold text-blue-800 mb-2">ğŸ“Š Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL:</label>
                    <div class="flex gap-2">
                        <input type="text" id="spreadsheetUrl" placeholder="ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’è²¼ã‚Šä»˜ã‘" class="flex-1 p-2 border rounded">
                        <button onclick="loadFromUrl()" class="bg-blue-500 text-white px-4 py-2 rounded">èª­ã¿è¾¼ã‚€</button>
                    </div>
                    <p class="text-xs text-blue-600 mt-2">
                        â€»å…±æœ‰è¨­å®šã‚’ã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ã€ã«ã—ã¦ãã ã•ã„ã€‚<br>
                        â€»Aåˆ—: å­¦å¹´, Båˆ—: å˜å…ƒå, Cåˆ—: å•é¡Œæ–‡ï¼ˆ5ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°ãƒã‚§ãƒƒã‚¯ï¼‰ã€‚
                    </p>
                </div>

                <div class="flex-1 overflow-auto border-2 rounded-xl">
                    <table id="spreadsheetTable" class="w-full text-left border-collapse">
                    </table>
                </div>

                <div class="flex gap-2 mt-4 justify-center">
                    <button onclick="saveAndReturn()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold">ğŸ’¾ ä¿å­˜ã—ã¦æˆ»ã‚‹</button>
                    <button onclick="addRow()" class="bg-gray-500 text-white px-4 py-2 rounded-xl">è¡Œã‚’è¿½åŠ </button>
                    <button onclick="clearAll()" class="bg-gray-300 px-4 py-2 rounded-xl">ã‚¯ãƒªã‚¢</button>
                    <button onclick="closeEditDialog()" class="bg-gray-100 px-4 py-2 rounded-xl">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®š: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆURL
        const correctPassword = "kanji";
        const DEFAULT_SHEET_URL = "https://docs.google.com/spreadsheets/d/1a2CyIJCM5Nqy6Hah6249_Era1jyw11QmhAIJQGzoesA/edit?gid=649883566#gid=649883566";
        
        let revealedCount = 0;
        let totalBlanks = 0;
        let autoUpdateInterval = null;
        let lastRawData = ""; 
        let isSettingsLoaded = false;

        // å­¦å¹´ã®ä¸¦ã³é †å®šç¾©
        const unitOrder = ["å°å­¦1å¹´ç”Ÿ", "å°å­¦2å¹´ç”Ÿ", "å°å­¦3å¹´ç”Ÿ", "å°å­¦4å¹´ç”Ÿ", "å°å­¦5å¹´ç”Ÿ", "å°å­¦6å¹´ç”Ÿ", "ä¸­å­¦1å¹´ç”Ÿ", "ä¸­å­¦2å¹´ç”Ÿ", "ä¸­å­¦3å¹´ç”Ÿ"];

        let problems = [];
        let displayProblems = [];

        async function init() {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å‰å›ä¿å­˜ã—ãŸURLãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
            const savedUrl = localStorage.getItem('kanji_app_sheet_url');
            document.getElementById('spreadsheetUrl').value = savedUrl || DEFAULT_SHEET_URL;
            
            // åˆå›èª­ã¿è¾¼ã¿
            await loadFromUrl(true); 
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®ä¿å­˜ (localStorage)
        const saveUserSetting = () => {
            const settings = {
                grade: document.getElementById('gradeSelector').value,
                unit: document.getElementById('unitSelector').value,
                range: document.getElementById('rangeSelector').value
            };
            try {
                localStorage.setItem('kanji_app_settings', JSON.stringify(settings));
            } catch (e) {
                console.error("è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
            }
        };

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®å¾©å…ƒ (localStorage)
        const restoreUserSetting = () => {
            if (isSettingsLoaded) return;
            try {
                const settingsJson = localStorage.getItem('kanji_app_settings');
                if (settingsJson) {
                    const data = JSON.parse(settingsJson);
                    const gradeSelector = document.getElementById('gradeSelector');
                    const unitSelector = document.getElementById('unitSelector');
                    const rangeSelector = document.getElementById('rangeSelector');

                    // å­¦å¹´ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®å¾©å…ƒ
                    if ([...gradeSelector.options].some(o => o.value === data.grade)) {
                        gradeSelector.value = data.grade;
                    }
                    
                    // å­¦å¹´ã«å¿œã˜ã¦å˜å…ƒã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’æ›´æ–°
                    updateUnitSelector();
                    
                    // å˜å…ƒã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®å¾©å…ƒ
                    if ([...unitSelector.options].some(o => o.value === data.unit)) {
                        unitSelector.value = data.unit;
                    }
                    
                    // ç¯„å›²ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®å¾©å…ƒ
                    if ([...rangeSelector.options].some(o => o.value === data.range)) {
                        rangeSelector.value = data.range;
                    }

                    filterByUnit();
                }
                isSettingsLoaded = true;
            } catch (e) {
                console.error("è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
            }
        };

        function updateGradeSelector() {
            const gradeSelector = document.getElementById('gradeSelector');
            const currentGradeValue = gradeSelector.value;
            
            // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªå­¦å¹´ã‚’æŠ½å‡ºã—ã€unitOrderã®å®šç¾©é †ã«ã‚½ãƒ¼ãƒˆ
            const grades = [...new Set(problems.map(p => p.grade))].sort((a,b) => {
                const idxA = unitOrder.indexOf(a);
                const idxB = unitOrder.indexOf(b);
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                return a.localeCompare(b, 'ja');
            });

            gradeSelector.innerHTML = '<option value="all">ã™ã¹ã¦ã®å­¦å¹´</option>';
            grades.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                opt.textContent = g;
                gradeSelector.appendChild(opt);
            });
            
            // ä»¥å‰ã®é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒï¼ˆã‚‚ã—é¸æŠè‚¢ã«ã‚ã‚Œã°ï¼‰
            if ([...gradeSelector.options].some(o => o.value === currentGradeValue)) {
                gradeSelector.value = currentGradeValue;
            } else {
                gradeSelector.value = 'all';
            }
        }

        function updateUnitSelector() {
            const gradeSelector = document.getElementById('gradeSelector');
            const unitSelector = document.getElementById('unitSelector');
            const selectedGrade = gradeSelector.value;

            // é¸æŠã•ã‚ŒãŸå­¦å¹´ã®å•é¡Œã‹ã‚‰å˜å…ƒã‚’æŠ½å‡º
            const filteredForUnits = selectedGrade === 'all' 
                ? problems 
                : problems.filter(p => p.grade === selectedGrade);
            
            // é‡è¤‡ãªã—ã®å˜å…ƒãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä¸¦ã³é †ã‚’ç¶­æŒï¼‰
            const units = [];
            filteredForUnits.forEach(p => {
                if (!units.includes(p.unit)) {
                    units.push(p.unit);
                }
            });

            unitSelector.innerHTML = '<option value="all">ã™ã¹ã¦ã®å˜å…ƒ</option>';
            units.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.textContent = u;
                unitSelector.appendChild(opt);
            });
        }

        function onGradeChange() {
            const unitSelector = document.getElementById('unitSelector');
            unitSelector.value = 'all'; // å­¦å¹´ãŒå¤‰ã‚ã£ãŸã‚‰å˜å…ƒã¯ãƒªã‚»ãƒƒãƒˆ
            updateUnitSelector();
            filterByUnit();
            saveUserSetting();
        }

        function onUnitChange() {
            filterByUnit();
            saveUserSetting();
        }

        function onRangeChange() {
            filterByUnit();
            saveUserSetting();
        }

        function renderCards() {
            const area = document.getElementById('cardsArea');
            area.innerHTML = '';

            displayProblems.forEach((p, idx) => {
                const card = document.createElement('div');
                card.className = 'sentence-card';
                
                const num = document.createElement('div');
                num.className = 'problem-number';
                num.textContent = idx + 1;
                card.appendChild(num);

                const sentence = document.createElement('div');
                sentence.className = 'sentence';
                
                const parts = p.sentence.split(/(\{.+?\|.+?\})/);
                parts.forEach((part, pIdx) => {
                    if (part.startsWith('{')) {
                        const content = part.slice(1, -1).split('|');
                        const kanji = content[0];
                        const reading = content[1];
                        const blankId = `blank-${idx}-${pIdx}`;
                        
                        const blank = document.createElement('span');
                        blank.className = 'kanji-blank';
                        blank.id = blankId;
                        blank.setAttribute('data-kanji', kanji);
                        blank.setAttribute('data-reading', reading);
                        blank.innerHTML = `<button class="reveal-btn individual-btn" onclick="revealKanji('${blankId}')">ç­”ãˆ</button>`;
                        
                        sentence.appendChild(blank);
                    } else {
                        sentence.appendChild(document.createTextNode(part));
                    }
                });

                card.appendChild(sentence);
                area.appendChild(card);
            });
        }

        function revealKanji(id) {
            const blank = document.getElementById(id);
            if (!blank) return;
            if (!blank.classList.contains('revealed')) {
                const kanji = blank.getAttribute('data-kanji');
                blank.innerHTML = `${kanji}<button class="reveal-btn individual-btn" style="background:#a0aec0" onclick="revealKanji('${id}')">éš ã™</button>`;
                blank.classList.add('revealed');
            } else {
                blank.innerHTML = `<button class="reveal-btn individual-btn" onclick="revealKanji('${id}')">ç­”ãˆ</button>`;
                blank.classList.remove('revealed');
            }
        }

        function toggleAllReveals() {
            const btn = document.getElementById('globalToggleBtn');
            const blanks = document.querySelectorAll('.kanji-blank');
            const isShowingAll = btn.textContent === 'ã™ã¹ã¦éš ã™';

            blanks.forEach(b => {
                const revealed = b.classList.contains('revealed');
                if (!isShowingAll && !revealed) revealKanji(b.id);
                if (isShowingAll && revealed) revealKanji(b.id);
            });

            btn.textContent = isShowingAll ? 'ã™ã¹ã¦è¡¨ç¤º' : 'ã™ã¹ã¦éš ã™';
        }

        function shuffleProblems() {
            displayProblems.sort(() => Math.random() - 0.5);
            renderCards();
        }

        function filterByUnit() {
            const grade = document.getElementById('gradeSelector').value;
            const unit = document.getElementById('unitSelector').value;
            const range = document.getElementById('rangeSelector').value;

            let filtered = [...problems];

            if (grade !== 'all') {
                filtered = filtered.filter(p => p.grade === grade);
            }

            if (unit !== 'all') {
                if (range === 'only') {
                    filtered = filtered.filter(p => p.unit === unit);
                } else {
                    // å˜å…ƒãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆè¡¨ç¤ºé †ï¼‰
                    const currentUnits = [];
                    filtered.forEach(p => {
                        if(!currentUnits.includes(p.unit)) currentUnits.push(p.unit);
                    });
                    const targetIdx = currentUnits.indexOf(unit);
                    filtered = filtered.filter(p => currentUnits.indexOf(p.unit) <= targetIdx);
                }
            }

            // 50å•åˆ¶é™: 51å•ä»¥ä¸Šã®å ´åˆã¯ãƒ©ãƒ³ãƒ€ãƒ ã«50å•é¸å‡º
            if (filtered.length > 50) {
                filtered = filtered.sort(() => Math.random() - 0.5).slice(0, 50);
            }

            displayProblems = filtered;
            renderCards();
        }

        function showEditDialog() { document.getElementById('editDialog').classList.remove('hidden'); }
        function closeEditDialog() { document.getElementById('editDialog').classList.add('hidden'); }

        function checkPassword() {
            if (document.getElementById('passwordInput').value === correctPassword) {
                document.getElementById('passwordSection').classList.add('hidden');
                document.getElementById('editSection').classList.remove('hidden');
                createSpreadsheet();
            } else {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
            }
        }

        function createSpreadsheet() {
            const table = document.getElementById('spreadsheetTable');
            table.innerHTML = `<tr class="bg-gray-100"><th class="p-2 border">å­¦å¹´</th><th class="p-2 border">å˜å…ƒå</th><th class="p-2 border">å•é¡Œæ–‡</th></tr>`;
            problems.forEach((p, i) => addRow(p.grade, p.unit, p.sentence));
        }

        function addRow(grade = "", unit = "", sentence = "") {
            const table = document.getElementById('spreadsheetTable');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="border"><input type="text" class="w-full p-2 edit-grade-input" value="${grade}"></td>
                <td class="border"><input type="text" class="w-full p-2 edit-unit-input" value="${unit}"></td>
                <td class="border"><input type="text" class="w-full p-2 edit-sentence-input" value="${sentence}"></td>
            `;
            table.appendChild(tr);
        }

        function saveAndReturn() {
            const grades = document.querySelectorAll('.edit-grade-input');
            const units = document.querySelectorAll('.edit-unit-input');
            const sents = document.querySelectorAll('.edit-sentence-input');
            problems = [];
            grades.forEach((g, i) => {
                if (sents[i].value) {
                    problems.push({ 
                        grade: g.value || "æœªåˆ†é¡", 
                        unit: units[i].value || "æœªåˆ†é¡", 
                        sentence: sents[i].value 
                    });
                }
            });
            lastRawData = ""; 
            updateGradeSelector();
            updateUnitSelector();
            filterByUnit();
            closeEditDialog();
        }

        async function loadFromUrl(isInitial = false) {
            let url = document.getElementById('spreadsheetUrl').value;
            if (!url) return;
            
            // URLã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            localStorage.setItem('kanji_app_sheet_url', url);

            const sheetId = url.match(/\/d\/([a-zA-Z0-9-_]+)/)?.[1];
            const gid = url.match(/gid=([0-9]+)/)?.[1] || "0";
            
            if (!sheetId) return alert('URLãŒç„¡åŠ¹ã§ã™');
            
            // GitHub Pagesç­‰ã®å¤–éƒ¨ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ç”¨ã«Google Visualization APIã‚’ä½¿ç”¨
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}`;
            
            const fetchData = async () => {
                try {
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿
                    const res = await fetch(`${csvUrl}&t=${new Date().getTime()}`);
                    if (!res.ok) return;
                    const data = await res.text();
                    
                    if (data === lastRawData) return;
                    lastRawData = data;

                    // Google Visualization APIã®CSVã¯ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã¾ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚é™¤å»
                    const rows = data.split('\n').map(r => {
                        // ç°¡æ˜“CSVãƒ‘ãƒ¼ã‚¹: ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã ãŒã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå†…ã®ã‚«ãƒ³ãƒã¯ç„¡è¦–ã™ã‚‹ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯
                        // å¼•ç”¨ç¬¦å†…ã®ã‚«ãƒ³ãƒã‚’ä¸€æ™‚çš„ã«ç½®æ›ã™ã‚‹ã‹ã€æ­£è¦è¡¨ç¾ã§åˆ†å‰²
                        const matches = r.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                        if (matches.length === 0) return r.split(',');
                        return matches.map(m => m.replace(/^"|"$/g, '').replace(/""/g, '"'));
                    });
                    
                    // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é™¤å»ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
                    problems = rows.slice(1).map(r => ({
                        grade: r[0]?.trim() || "æœªåˆ†é¡",
                        unit: r[1]?.trim() || "æœªåˆ†é¡",
                        sentence: r[2]?.trim() || ""
                    })).filter(p => p.sentence && p.sentence !== "");
                    
                    if (document.getElementById('editDialog').classList.contains('hidden') || isInitial) {
                        updateGradeSelector();
                        updateUnitSelector();
                        
                        if (isInitial) {
                            restoreUserSetting();
                        } else {
                            // è‡ªå‹•æ›´æ–°æ™‚ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠçŠ¶æ…‹ã‚’ç¶­æŒã—ãŸã¾ã¾å†æç”»
                            filterByUnit();
                        }
                    }
                } catch (e) { 
                    console.error("Data Fetch Error:", e); 
                }
            };

            await fetchData();

            // 5ç§’é–“éš”ã§æ›´æ–°ãƒã‚§ãƒƒã‚¯
            if (autoUpdateInterval) clearInterval(autoUpdateInterval);
            autoUpdateInterval = setInterval(fetchData, 5000);
        }

        function clearAll() {
            problems = [];
            createSpreadsheet();
        }

        init();
    </script>
</body>
</html>
